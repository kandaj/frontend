name: DORA Metrics Collection
on:
  workflow_run:
    workflows: ["release"]   # Must match the exact name of your release workflow
    types: [completed]

permissions:
  contents: read
  id-token: write

jobs:
  collect-metrics:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # -----------------------------
      # Configure AWS credentials
      # -----------------------------
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: ${{ secrets.AWS_REGION || 'eu-west-1' }}

      # -----------------------------
      # 1. Detect deployment metadata
      # -----------------------------
      - name: Detect Trigger Context
        id: meta
        run: |
          COMMIT_SHA="${{ github.event.workflow_run.head_sha }}"
          CONCLUSION="${{ github.event.workflow_run.conclusion }}"

          echo "commit_sha=$COMMIT_SHA" >> $GITHUB_OUTPUT
          echo "conclusion=$CONCLUSION" >> $GITHUB_OUTPUT
          echo "environment=production" >> $GITHUB_OUTPUT
          echo "service=telescope" >> $GITHUB_OUTPUT

          echo "Deployment finished: commit=$COMMIT_SHA status=$CONCLUSION"

      # -----------------------------
      # 2. Detect release tags
      # -----------------------------
      - name: Detect Release Tags
        id: tags
        run: |
          COMMIT_SHA="${{ steps.meta.outputs.commit_sha }}"

          CURRENT_TAG=$(git describe --tags --exact-match $COMMIT_SHA 2>/dev/null || echo "")
          echo "Current release tag: $CURRENT_TAG"

          if [ -z "$CURRENT_TAG" ]; then
            echo "No release tag found — not a production release."
            echo "current_tag=" >> $GITHUB_OUTPUT
            echo "previous_tag=" >> $GITHUB_OUTPUT
            exit 0
          fi

          PREV_TAG=$(git describe --tags --abbrev=0 ${CURRENT_TAG}^ 2>/dev/null || echo "")
          echo "Previous release tag: $PREV_TAG"

          echo "current_tag=$CURRENT_TAG" >> $GITHUB_OUTPUT
          echo "previous_tag=$PREV_TAG" >> $GITHUB_OUTPUT

      # -----------------------------
      # 3. Record SUCCESS metrics
      #    - Lead Time
      #    - Batch Size
      #    - Deployment Count
      #    - Deployment Duration
      # -----------------------------
      - name: Record Successful Deployment Metrics
        if: ${{ steps.meta.outputs.conclusion == 'success' && steps.tags.outputs.current_tag != '' }}
        run: |
          CURRENT_TAG="${{ steps.tags.outputs.current_tag }}"
          PREV_TAG="${{ steps.tags.outputs.previous_tag }}"

          echo "Computing metrics for release $CURRENT_TAG"

          # -------- Lead Time ----------
          if [ -z "$PREV_TAG" ]; then
            echo "First release — using initial commit on main"
            FIRST_COMMIT=$(git rev-list --max-parents=0 main)
          else
            # Only consider commits merged into main
            FIRST_COMMIT=$(git log --first-parent main --format=%H --reverse ${PREV_TAG}..${CURRENT_TAG} | head -1)
          fi

          FIRST_COMMIT_TIME=$(git show -s --format=%ct $FIRST_COMMIT)
          DEPLOY_TIME=$(date +%s)
          LEAD_TIME=$((DEPLOY_TIME - FIRST_COMMIT_TIME))
          echo "Lead Time = ${LEAD_TIME}s"

          # -------- Batch Size ----------
          if [ -z "$PREV_TAG" ]; then
            COMMIT_COUNT=$(git rev-list --first-parent --count main)
          else
            COMMIT_COUNT=$(git rev-list --first-parent --count ${PREV_TAG}..${CURRENT_TAG})
          fi
          echo "Batch Size = $COMMIT_COUNT commits"

          # -------- Deployment Duration ----------
          DURATION_MS="${{ github.event.workflow_run.run_duration_ms }}"
          if [ -z "$DURATION_MS" ]; then
            echo "No duration reported for workflow run"
            DURATION_SECONDS=0
          else
            DURATION_SECONDS=$((DURATION_MS / 1000))
          fi
          echo "Deployment Duration = ${DURATION_SECONDS}s"

          # -------- Send metrics to CloudWatch ----------
          # aws cloudwatch put-metric-data \
          #   --namespace "DORA" \
          #   --metric-name "LeadTimeForChanges" \
          #   --value $LEAD_TIME \
          #   --unit Seconds \
          #   --dimensions Pipeline="${{ github.repository }}",Service=${{ steps.meta.outputs.service }},Environment=${{ steps.meta.outputs.environment }}

          # aws cloudwatch put-metric-data \
          #   --namespace "DORA" \
          #   --metric-name "BatchSize" \
          #   --value $COMMIT_COUNT \
          #   --unit Count \
          #   --dimensions Pipeline="${{ github.repository }}",Service=${{ steps.meta.outputs.service }},Environment=${{ steps.meta.outputs.environment }},Release=$CURRENT_TAG

          # aws cloudwatch put-metric-data \
          #   --namespace "DORA" \
          #   --metric-name "DeploymentCount" \
          #   --value 1 \
          #   --unit Count \
          #   --dimensions Pipeline="${{ github.repository }}",Service=${{ steps.meta.outputs.service }},Environment=${{ steps.meta.outputs.environment }}


      # -----------------------------
      # 4. Record FAILED deployments
      # -----------------------------
      - name: Record Failed Deployment
        if: ${{ steps.meta.outputs.conclusion != 'success' }}
        run: |
          echo "Deployment failed — recording metric."

          # aws cloudwatch put-metric-data \
          #   --namespace "DORA" \
          #   --metric-name "FailedDeployment" \
          #   --value 1 \
          #   --unit Count \
          #   --dimensions Pipeline="${{ github.repository }}",Service=${{ steps.meta.outputs.service }},Environment=${{ steps.meta.outputs.environment }}
