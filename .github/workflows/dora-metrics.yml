name: DORA Metrics Collection
on:
  workflow_run:
    workflows: ["release"]   # Must match the exact name of your release workflow
    types:
      - completed

permissions:
  contents: read
  id-token: write

jobs:
  collect-metrics:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # -----------------------------
      # Configure AWS credentials
      # -----------------------------
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: ${{ secrets.AWS_REGION || 'eu-west-1' }}

      # -----------------------------
      # Deployment metadata
      # -----------------------------
      - name: Detect Trigger Context
        id: meta
        run: |
          echo "commit_sha=${{ github.event.workflow_run.head_sha }}" >> $GITHUB_OUTPUT
          echo "conclusion=${{ github.event.workflow_run.conclusion }}" >> $GITHUB_OUTPUT
          echo "environment=production" >> $GITHUB_OUTPUT
          echo "service=telescope" >> $GITHUB_OUTPUT

      # -----------------------------
      # Release timestamps
      # -----------------------------
      - name: Detect Release Information
        id: releases
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          RELEASES=$(gh api repos/${{ github.repository }}/releases \
            --paginate --jq '.[] | {tag: .tag_name, published: .published_at}')

          if [ -z "$RELEASES" ]; then
            echo "No releases found"
            exit 0
          fi

          CURRENT_RELEASE=$(echo "$RELEASES" | sort -r -k2 | head -1)
          PREVIOUS_RELEASE=$(echo "$RELEASES" | sort -r -k2 | sed -n '2p')

          CURRENT_PUB=$(echo "$CURRENT_RELEASE" | jq -r '.published')
          PREV_PUB=$(echo "$PREVIOUS_RELEASE" | jq -r '.published // empty')

          echo "published_at=$CURRENT_PUB" >> $GITHUB_OUTPUT
          echo "previous_published_at=$PREV_PUB" >> $GITHUB_OUTPUT

      # -----------------------------
      # Compute DORA Metrics
      # -----------------------------
      - name: Compute DORA Metrics (timestamp-based)
        run: |
          CURRENT_PUB="${{ steps.releases.outputs.published_at }}"
          PREV_PUB="${{ steps.releases.outputs.previous_published_at }}"

          if [ -z "$PREV_PUB" ]; then
            PREV_PUB=$(git log --reverse --format=%aI | head -1)
          fi

          SINCE="$PREV_PUB"
          UNTIL="$CURRENT_PUB"

          COMMITS=$(git log --pretty=format:"%H %aI %s" \
            --since="$SINCE" --until="$UNTIL" --reverse)

          COMMIT_COUNT=$(echo "$COMMITS" | wc -l)

          echo "COMMITS FOUND:"
          echo "$COMMITS"

          # Earliest commit timestamp in this release window
          FIRST_COMMIT_TIMESTAMP=$(echo "$COMMITS" | head -1 | awk '{print $2}')

          # Convert timestamps to epoch seconds for calculations
          FIRST_COMMIT_EPOCH=$(date -d "$FIRST_COMMIT_TIMESTAMP" +%s)
          CURRENT_RELEASE_EPOCH=$(date -d "$CURRENT_PUB" +%s)
          PREVIOUS_RELEASE_EPOCH=$(date -d "$PREV_PUB" +%s)

          # Compute metrics
          LEAD_TIME=$(( CURRENT_RELEASE_EPOCH - FIRST_COMMIT_EPOCH ))
          DEPLOYMENT_INTERVAL=$(( CURRENT_RELEASE_EPOCH - PREVIOUS_RELEASE_EPOCH ))

          echo "COMMIT_COUNT=$COMMIT_COUNT"
          echo "LEAD_TIME=$LEAD_TIME"
          echo "DEPLOYMENT_INTERVAL=$DEPLOYMENT_INTERVAL"


          echo "========================================"
          echo "Sending metrics to CloudWatch..."
          echo "========================================"

          # ------- Send to CloudWatch ------------
          # aws cloudwatch put-metric-data \
          #   --namespace "DORA" \
          #   --metric-name "LeadTimeForChanges" \
          #   --value "$LEAD_TIME" \
          #   --unit Seconds \
          #   --dimensions Pipeline="${{ github.repository }}",Service=telescope,Environment=production

          # aws cloudwatch put-metric-data \
          #   --namespace "DORA" \
          #   --metric-name "BatchSize" \
          #   --value "$COMMIT_COUNT" \
          #   --unit Count \
          #   --dimensions Pipeline="${{ github.repository }}",Service=telescope,Environment=production

          # aws cloudwatch put-metric-data \
          #   --namespace "DORA" \
          #   --metric-name "DeploymentCount" \
          #   --value 1 \
          #   --unit Count \
          #   --dimensions Pipeline="${{ github.repository }}",Service=telescope,Environment=production

          # if [ $DEPLOYMENT_INTERVAL -gt 0 ]; then
          #   aws cloudwatch put-metric-data \
          #     --namespace "DORA" \
          #     --metric-name "DeploymentInterval" \
          #     --value "$DEPLOYMENT_INTERVAL" \
          #     --unit Seconds \
          #     --dimensions Pipeline="${{ github.repository }}",Service=telescope,Environment=production
          # fi

      # -----------------------------
      # Record FAILED deployments
      # -----------------------------
      - name: Record Failed Deployment
        if: ${{ steps.meta.outputs.conclusion != 'success' }}
        run: |
          echo "Deployment failed â€” recording metric."
          aws cloudwatch put-metric-data \
            --namespace "DORA" \
            --metric-name "FailedDeployment" \
            --value 1 \
            --unit Count \
            --dimensions Pipeline="${{ github.repository }}",Service=${{ steps.meta.outputs.service }},Environment=${{ steps.meta.outputs.environment }}

          # Also record as change failure if there's a release tag
          CURRENT_RELEASE="${{ steps.releases.outputs.current_release }}"
          if [ -n "$CURRENT_RELEASE" ]; then
            aws cloudwatch put-metric-data \
              --namespace "DORA" \
              --metric-name "ChangeFailure" \
              --value 1 \
              --unit Count \
              --dimensions Pipeline="${{ github.repository }}",Service=telescope,Environment=production,Release=${CURRENT_RELEASE}
          fi
