name: DORA Metrics Collection

on:
  workflow_run:
    workflows: ["CI-Deploy-TWeb-TAPI-TTV-to-Live"]
    types: [completed]

jobs:
  collect-metrics:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # ‚úÖ Configure AWS credentials
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: ${{ secrets.AWS_REGION || 'eu-west-1' }}

      # üß≠ Detect trigger type and environment/service
      - name: Detect Trigger Context
        id: meta
        run: |
          if [[ "${{ github.event_name }}" == "workflow_run" ]]; then
            echo "Triggered by workflow_run: ${{ github.event.workflow_run.name }}"
            
            COMMIT_SHA="${{ github.event.workflow_run.head_sha }}"
            CONCLUSION="${{ github.event.workflow_run.conclusion }}"
            
            # Always production for this deployment workflow
            ENVIRONMENT="production"
            
            # Store common values
            echo "commit_sha=$COMMIT_SHA" >> $GITHUB_OUTPUT
            echo "conclusion=$CONCLUSION" >> $GITHUB_OUTPUT
            echo "environment=$ENVIRONMENT" >> $GITHUB_OUTPUT
            
            # Set a default service (will be used for aggregated metrics)
            echo "service=telescope" >> $GITHUB_OUTPUT
            
            echo "Deployment to production completed with status: $CONCLUSION"
          else
            echo "Triggered manually via workflow_dispatch"
            echo "service=${{ github.event.inputs.service }}" >> $GITHUB_OUTPUT
            echo "environment=${{ github.event.inputs.environment }}" >> $GITHUB_OUTPUT
            echo "commit_sha=${{ github.sha }}" >> $GITHUB_OUTPUT
            echo "conclusion=success" >> $GITHUB_OUTPUT
          fi

      # ‚úÖ Record successful deployments
      - name: Record Successful Deployment Metrics
        if: ${{ steps.meta.outputs.conclusion == 'success' }}
        run: |
          FIRST_COMMIT=$(git log --format=%H --reverse ${{ steps.meta.outputs.commit_sha }} ^main | head -1)
          FIRST_COMMIT_TIME=$(git show -s --format=%ct $FIRST_COMMIT)
          DEPLOY_TIME=$(date +%s)
          LEAD_TIME=$((DEPLOY_TIME - FIRST_COMMIT_TIME))

          echo "Lead time for changes: ${LEAD_TIME}s"

          aws cloudwatch put-metric-data \
            --namespace "DORA" \
            --metric-name "LeadTimeForChanges" \
            --value $LEAD_TIME \
            --unit Seconds \
            --dimensions Pipeline="${{ github.repository }}",Service=${{ steps.meta.outputs.service }},Environment=${{ steps.meta.outputs.environment }}

          aws cloudwatch put-metric-data \
            --namespace "DORA" \
            --metric-name "DeploymentCount" \
            --value 1 \
            --unit Count \
            --dimensions Pipeline="${{ github.repository }}",Service=${{ steps.meta.outputs.service }},Environment=${{ steps.meta.outputs.environment }}

      # ‚ö†Ô∏è Record failed deployments
      - name: Record Failed Deployment
        if: ${{ steps.meta.outputs.conclusion != 'success' }}
        run: |
          aws cloudwatch put-metric-data \
            --namespace "DORA" \
            --metric-name "FailedDeployment" \
            --value 1 \
            --unit Count \
            --dimensions Pipeline="${{ github.repository }}",Service=${{ steps.meta.outputs.service }},Environment=${{ steps.meta.outputs.environment }}