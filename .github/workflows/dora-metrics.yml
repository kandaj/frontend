name: DORA Metrics Collection
on:
  workflow_run:
    workflows: ["release"]   # Must match the exact name of your release workflow
    types:
      - completed

permissions:
  contents: read
  id-token: write

jobs:
  collect-metrics:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # -----------------------------
      # Configure AWS credentials
      # -----------------------------
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: ${{ secrets.AWS_REGION || 'eu-west-1' }}

      # -----------------------------
      # 1. Detect deployment metadata
      # -----------------------------
      - name: Detect Trigger Context
        id: meta
        run: |
          COMMIT_SHA="${{ github.event.workflow_run.head_sha }}"
          CONCLUSION="${{ github.event.workflow_run.conclusion }}"

          echo "commit_sha=$COMMIT_SHA" >> $GITHUB_OUTPUT
          echo "conclusion=$CONCLUSION" >> $GITHUB_OUTPUT
          echo "environment=production" >> $GITHUB_OUTPUT
          echo "service=telescope" >> $GITHUB_OUTPUT

          echo "Deployment finished: commit=$COMMIT_SHA status=$CONCLUSION"

      # -----------------------------
      # 2. Detect Current and Previous Release
      # -----------------------------
      - name: Detect Release Information
        id: releases
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          COMMIT_SHA="${{ steps.meta.outputs.commit_sha }}"

          RELEASES_JSON=$(curl -s -H "Authorization: Bearer ${GH_TOKEN}" \
            -H "Accept: application/vnd.github+json" \
            "https://api.github.com/repos/${{ github.repository }}/releases?per_page=100")

          # Sort releases by published date descending
          SORTED=$(echo "$RELEASES_JSON" | jq -r 'sort_by(.published_at) | reverse')

          CURRENT_RELEASE_DATA=$(echo "$SORTED" | jq '.[0]')
          PREV_RELEASE_DATA=$(echo "$SORTED" | jq '.[1]')

          if [[ "$CURRENT_RELEASE_DATA" == "null" ]]; then
            echo "No releases found!"
            exit 0
          fi

          CURRENT_RELEASE=$(echo "$CURRENT_RELEASE_DATA" | jq -r '.tag_name')
          CURRENT_COMMIT=$(echo "$CURRENT_RELEASE_DATA" | jq -r '.target_commitish')
          PUBLISHED_AT=$(echo "$CURRENT_RELEASE_DATA" | jq -r '.published_at')

          if [[ "$PREV_RELEASE_DATA" != "null" ]]; then
            PREV_RELEASE=$(echo "$PREV_RELEASE_DATA" | jq -r '.tag_name')
            PREV_COMMIT=$(echo "$PREV_RELEASE_DATA" | jq -r '.target_commitish')
            PREV_PUBLISHED=$(echo "$PREV_RELEASE_DATA" | jq -r '.published_at')
          else
            PREV_RELEASE=""
            PREV_COMMIT=""
            PREV_PUBLISHED=""
          fi

          echo "current_release=$CURRENT_RELEASE" >> $GITHUB_OUTPUT
          echo "previous_release=$PREV_RELEASE" >> $GITHUB_OUTPUT
          echo "current_commit=$CURRENT_COMMIT" >> $GITHUB_OUTPUT
          echo "previous_commit=$PREV_COMMIT" >> $GITHUB_OUTPUT
          echo "published_at=$PUBLISHED_AT" >> $GITHUB_OUTPUT
          echo "previous_published_at=$PREV_PUBLISHED" >> $GITHUB_OUTPUT

      # -----------------------------
      # 3. Compute DORA Metrics
      # -----------------------------
      - name: Compute DORA Metrics
        if: ${{ steps.releases.outputs.current_release != '' }}
        run: |
          CURRENT_COMMIT="${{ steps.releases.outputs.current_commit }}"
          PREV_COMMIT="${{ steps.releases.outputs.previous_commit }}"
          PUBLISHED_AT="${{ steps.releases.outputs.published_at }}"
          PREV_PUBLISHED="${{ steps.releases.outputs.previous_published_at }}"

          echo "Calculating DORA metrics for release ${{ steps.releases.outputs.current_release }}"

          # Lead Time: first commit → release published
          if [ -z "$PREV_COMMIT" ]; then
            FIRST_COMMIT=$(git rev-list --max-parents=0 main)
          else
            FIRST_COMMIT=$(git log --format=%H --reverse ${PREV_COMMIT}..${CURRENT_COMMIT} | head -1)
          fi

          FIRST_COMMIT_TIME=$(git show -s --format=%ct $FIRST_COMMIT)
          RELEASE_TIME=$(date -d "$PUBLISHED_AT" +%s 2>/dev/null || date -j -f "%Y-%m-%dT%H:%M:%SZ" "$PUBLISHED_AT" +%s)
          LEAD_TIME=$((RELEASE_TIME - FIRST_COMMIT_TIME))
          echo "Lead Time: $LEAD_TIME seconds (≈ $((LEAD_TIME / 86400)) days)"

          # Batch Size: commits between previous and current release
          if [ -z "$PREV_COMMIT" ]; then
            COMMIT_COUNT=$(git rev-list --first-parent --count main)
          else
            COMMIT_COUNT=$(git rev-list --first-parent --count ${PREV_COMMIT}..${CURRENT_COMMIT})
          fi
          echo "Batch Size: $COMMIT_COUNT commits"

          # Deployment Frequency: time between current and previous release
          if [ -n "$PREV_PUBLISHED" ]; then
            PREV_RELEASE_TIME=$(date -d "$PREV_PUBLISHED" +%s 2>/dev/null || date -j -f "%Y-%m-%dT%H:%M:%SZ" "$PREV_PUBLISHED" +%s)
            DEPLOYMENT_INTERVAL=$((RELEASE_TIME - PREV_RELEASE_TIME))
            echo "Time since previous release: $DEPLOYMENT_INTERVAL seconds (≈ $((DEPLOYMENT_INTERVAL / 86400)) days)"
          else
            DEPLOYMENT_INTERVAL=0
            echo "No previous release to calculate deployment frequency"
          fi

          echo "========================================"
          echo "Sending metrics to CloudWatch..."
          echo "========================================"

          #-------- Send metrics to CloudWatch ----------
          # aws cloudwatch put-metric-data \
          #   --namespace "DORA" \
          #   --metric-name "LeadTimeForChanges" \
          #   --value $LEAD_TIME \
          #   --unit Seconds \
          #   --dimensions Pipeline="${{ github.repository }}",Service=${{ steps.meta.outputs.service }},Environment=${{ steps.meta.outputs.environment }}

          # aws cloudwatch put-metric-data \
          #   --namespace "DORA" \
          #   --metric-name "BatchSize" \
          #   --value $COMMIT_COUNT \
          #   --unit Count \
          #   --dimensions Pipeline="${{ github.repository }}",Service=${{ steps.meta.outputs.service }},Environment=${{ steps.meta.outputs.environment }},Release=$CURRENT_RELEASE

          # aws cloudwatch put-metric-data \
          #   --namespace "DORA" \
          #   --metric-name "DeploymentCount" \
          #   --value 1 \
          #   --unit Count \
          #   --dimensions Pipeline="${{ github.repository }}",Service=${{ steps.meta.outputs.service }},Environment=${{ steps.meta.outputs.environment }}

          # # Send deployment interval if we have a previous release
          # if [ $DEPLOYMENT_INTERVAL -gt 0 ]; then
          #   aws cloudwatch put-metric-data \
          #     --namespace "DORA" \
          #     --metric-name "DeploymentInterval" \
          #     --value $DEPLOYMENT_INTERVAL \
          #     --unit Seconds \
          #     --dimensions Pipeline="${{ github.repository }}",Service=${{ steps.meta.outputs.service }},Environment=${{ steps.meta.outputs.environment }}
          # fi

          # echo "✓ Metrics successfully sent to CloudWatch"

      # -----------------------------
      # 4. Record FAILED deployments
      # -----------------------------
      - name: Record Failed Deployment
        if: ${{ steps.meta.outputs.conclusion != 'success' }}
        run: |
          echo "Deployment failed — recording metric."
          aws cloudwatch put-metric-data \
            --namespace "DORA" \
            --metric-name "FailedDeployment" \
            --value 1 \
            --unit Count \
            --dimensions Pipeline="${{ github.repository }}",Service=${{ steps.meta.outputs.service }},Environment=${{ steps.meta.outputs.environment }}

          # Also record as change failure if there's a release tag
          CURRENT_RELEASE="${{ steps.releases.outputs.current_release }}"
          if [ -n "$CURRENT_RELEASE" ]; then
            aws cloudwatch put-metric-data \
              --namespace "DORA" \
              --metric-name "ChangeFailure" \
              --value 1 \
              --unit Count \
              --dimensions Pipeline="${{ github.repository }}",Service=telescope,Environment=production,Release=${CURRENT_RELEASE}
          fi
