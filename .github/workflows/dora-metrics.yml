name: DORA Metrics Collection
on:
  workflow_run:
    workflows: ["release"]
    types: [completed]

permissions:
  contents: read
  id-token: write

jobs:
  collect-metrics:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: ${{ secrets.AWS_REGION || 'eu-west-1' }}

      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # 1. Detect deployment metadata
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Detect Trigger Context
        id: meta
        run: |
          COMMIT_SHA="${{ github.event.workflow_run.head_sha }}"
          CONCLUSION="${{ github.event.workflow_run.conclusion }}"

          echo "commit_sha=$COMMIT_SHA" >> $GITHUB_OUTPUT
          echo "conclusion=$CONCLUSION" >> $GITHUB_OUTPUT
          echo "environment=production" >> $GITHUB_OUTPUT
          echo "service=telescope" >> $GITHUB_OUTPUT

          echo "ğŸ“¦ Deployment finished: commit=$COMMIT_SHA status=$CONCLUSION"

      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # 2. Detect release tags (current + previous)
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Detect Release Tags
        id: tags
        run: |
          COMMIT_SHA="${{ steps.meta.outputs.commit_sha }}"
          
          # Ensure we have all tags
          git fetch --tags --force || true

          CURRENT_TAG=$(git describe --tags --exact-match $COMMIT_SHA 2>/dev/null || echo "")

          if [ -z "$CURRENT_TAG" ]; then
            echo "âš ï¸  No release tag found â€” not a production release."
            echo "current_tag=" >> $GITHUB_OUTPUT
            echo "previous_tag=" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          echo "âœ… Current release tag: $CURRENT_TAG"

          # Find previous release tag
          PREV_TAG=$(git describe --tags --abbrev=0 ${CURRENT_TAG}^ 2>/dev/null || echo "")
          
          if [ -n "$PREV_TAG" ]; then
            echo "ğŸ“Š Previous release tag: $PREV_TAG"
          else
            echo "ğŸ“Œ First release detected"
          fi

          echo "current_tag=$CURRENT_TAG" >> $GITHUB_OUTPUT
          echo "previous_tag=$PREV_TAG" >> $GITHUB_OUTPUT

      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # 3. Record SUCCESS metrics
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Record Successful Deployment Metrics
        if: ${{ steps.meta.outputs.conclusion == 'success' && steps.tags.outputs.current_tag != '' }}
        run: |
          CURRENT_TAG="${{ steps.tags.outputs.current_tag }}"
          PREV_TAG="${{ steps.tags.outputs.previous_tag }}"

          echo "ğŸ“ˆ Computing metrics for release $CURRENT_TAG"

          # Lead Time Calculation
          if [ -z "$PREV_TAG" ]; then
            echo "First release â€” using root commit."
            FIRST_COMMIT=$(git rev-list --max-parents=0 HEAD)
          else
            FIRST_COMMIT=$(git log --format=%H --reverse ${PREV_TAG}..${CURRENT_TAG} | head -1)
          fi

          FIRST_COMMIT_TIME=$(git show -s --format=%ct $FIRST_COMMIT)
          DEPLOY_TIME=$(date +%s)
          LEAD_TIME=$((DEPLOY_TIME - FIRST_COMMIT_TIME))

          echo "â±ï¸  Lead Time = ${LEAD_TIME}s"

          # Batch Size Calculation
          if [ -z "$PREV_TAG" ]; then
            COMMIT_COUNT=$(git rev-list --count ${CURRENT_TAG})
          else
            COMMIT_COUNT=$(git rev-list --count ${PREV_TAG}..${CURRENT_TAG})
          fi

          echo "ğŸ“¦ Batch Size = $COMMIT_COUNT commits"

          # Send metrics to CloudWatch
          # aws cloudwatch put-metric-data \
          #   --namespace "DORA" \
          #   --metric-name "LeadTimeForChanges" \
          #   --value $LEAD_TIME \
          #   --unit Seconds \
          #   --dimensions Pipeline="${{ github.repository }}",Service=telescope,Environment=production,Release=${CURRENT_TAG}

          # aws cloudwatch put-metric-data \
          #   --namespace "DORA" \
          #   --metric-name "DeploymentCount" \
          #   --value 1 \
          #   --unit Count \
          #   --dimensions Pipeline="${{ github.repository }}",Service=telescope,Environment=production,Release=${CURRENT_TAG}

          # aws cloudwatch put-metric-data \
          #   --namespace "DORA" \
          #   --metric-name "BatchSize" \
          #   --value $COMMIT_COUNT \
          #   --unit Count \
          #   --dimensions Pipeline="${{ github.repository }}",Service=telescope,Environment=production,Release=${CURRENT_TAG}
          
          echo "âœ… Metrics recorded successfully"
      
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # 4. Record failed deployments
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Record Failed Deployment
        if: ${{ steps.meta.outputs.conclusion != 'success' }}
        run: |
          echo "âŒ Deployment failed â€” recording metrics"
          
          CURRENT_TAG="${{ steps.tags.outputs.current_tag }}"

          # aws cloudwatch put-metric-data \
          #   --namespace "DORA" \
          #   --metric-name "FailedDeployment" \
          #   --value 1 \
          #   --unit Count \
          #   --dimensions Pipeline="${{ github.repository }}",Service=telescope,Environment=production${CURRENT_TAG:+,Release=${CURRENT_TAG}}
          
          # Also record as change failure if there's a release tag
          # if [ -n "$CURRENT_TAG" ]; then
          #   aws cloudwatch put-metric-data \
          #     --namespace "DORA" \
          #     --metric-name "ChangeFailure" \
          #     --value 1 \
          #     --unit Count \
          #     --dimensions Pipeline="${{ github.repository }}",Service=telescope,Environment=production,Release=${CURRENT_TAG}
          # fi